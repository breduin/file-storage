# Файловое хранилище

Проект предназначен для создания файлового хранилища с веб-интерфейсом на удалённом сервере. Загрузка файлов осуществляется с помощью Redis-очереди (RQ).

## Стек
- Python/Django;
- очередь RQ/Redis, [django-rq](https://github.com/rq/django-rq);
- Docker.

Использована [заготовка проекта](https://github.com/breduin/django-billet) Django с набором библиотек для
расширения функциональности.

Код является свободным, ты можешь установить его и пользоваться.

## Переменные окружения

Для улучшения уровня безопасности, когда будешь размещать сайт в общем доступе, сделай файл *.env* и размести его в папке настроек проекта *project*. В этом файле укажи:

* секретный ключ Django;
* DEBUG и ALLOWED_HOSTS
* данные для подключения к БД
* данные для подключения к Redis


Вот так должен выглядеть твой .env файл:

```
SECRET_KEY='длинная строка символов'
DEBUG=False
ALLOWED_HOSTS=127.0.0.1,[::1]
POSTGRES_DB=<имя БД>
POSTGRES_PASSWORD=<пароль пользователя БД>
POSTGRES_USER=<пользователь БД>
POSTGRES_DB_PORT=5432
```
Если запускаешь проект в контейнере Docker, то добавь
```
POSTGRES_DB_HOST=db
REDISTOGO_URL=redis://redis:6379
```
если без контейнера, то
```
POSTGRES_DB_HOST=localhost
REDISTOGO_URL=redis://localhost:6379
```

## Запуск проекта

Скачай репозиторий к себе.

### Docker

Для запуска проекта в контейнере перейди в папку проекта и запусти docker-compose:
```
docker-compose --env-file ./src/project/.env up
```
Открой браузер и укажи в адресной строке:
```
http://127.0.0.1:8000
```
чтобы попасть на главную страницу сайта.

Для того, чтобы попасть в административную часть сайта (админку), сначала создай суперпользователя БД в контейнере:

```
docker exec -it <id контейнера web> bash
cd src
./manage.py createsuperuser
```
затем в браузере перейди на страницу
```
http://127.0.0.1:8000/admin/
```

### Классический деплой 

Для этого тебе понадобится:

1. Установить Python 3.10+. [см. как установить (англ.)](https://realpython.com/installing-python/), а [здесь для Debian-based (рус.)](http://userone.ru/?q=node/41).

2. Установить и запустить [Redis](https://redis.io/topics/quickstart).


3. Установить и запустить [PostgreSQL](https://www.postgresql.org/download/).


Далее, установи и активируй виртуальное окружение:
```
    python3 -m venv env
    source env/bin/activate
```
перейди в папку проекта, установи необходимые библиотеки, указанные в файле requirements.txt:
```
    pip install -r requirements.txt
```
создай папку logs, в ней будут располагаться лог-файлы сервиса:
```
    mkdir logs
```

запусти миграции:
```
    ./manage.py migrate
```
создай суперпользователя сервиса:
```
    ./manage.py createsuperuser
```
Запусти воркер для обработки очереди RQ. Это можно сделать либо отдельным процессом *systemd* либо (для тестирования) в консоли:
```
./manage.py rqworker &
```
(не забудь потом после тестирования завершить этот процесс ```ps -aux | grep rqworker``` и ```kill -9 <id процесса>```).

Запусти проект:

```
    ./manage.py runserver 0.0.0.0:8000
```
Открой браузер и укажи в адресной строке:
```
http://127.0.0.1:8000
```
чтобы попасть на главную страницу сайта или
```
http://127.0.0.1:8000/admin/
```
для доступа к административной части сайта.


## Тесты

Для запуска юнит-тестов необходимо развернуть проект классическим способом, активировать виртуальное окружение и запустить скрипт тестирования в папке с кодом *src*: 

```sh
./run_tests.sh
```
